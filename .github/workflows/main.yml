name: CICD Pipeline
on:
  push:
    branches:
      - main 
      - master
  pull_request: 
    branches: 
      - main 
      - master
jobs:
  build: 
    runs-on: ubuntu-latest

    steps: 
    - name: checkout code
      uses: actions/checkout@v2
    - name: build with maven
      run: mvn clean install
    - name: sonarqube scan
      run: mvn sonar:sonar -Dsonar.projectkey=my_project -Dsonar.hst.url=https://sonar.your
    - name: Build docker image 
      run: | 
        docker build -t my-docker-repo/my-app:${{ github.sha }}
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin my-docker-repo
    - name: Push docker image
      run: |
        docker push my-docker-repo/my-app:${{ github.sha }}
    - name: upload to nexus
      env:
        NEXUS_USER: ${{ secrets.NEXUS_USERNAME }}
        NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
      run: |
        mvn deploy:deploy-file \
        -DgroupID=com.example \
        -DartifactId=my-app \
        -Dversion=${{ github.ha }} \
        -Dpackaging=jar \
        -Dfile=target/my-app-${{ github.sha }}.jar \
        -DrepositoryId=nexu-repo \
        -Durl=http://nexus.your-domain.com/repository/maven-releas/
    - name: Deploy to kubernets
      env: 
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      run: |
        echo $KUBE_CONFIG_DATA | base64 --decode > ~/.kube/config
        kubectl set image deployment/my-app my-app=my-docker-repo/my-app:${{ github.sha }} --record
    
